name: Build & Deploy FastAPI + Streamlit (single Container App)

on:
  push:
    branches: [ "main" ]

# Needed to push to GHCR with GITHUB_TOKEN
permissions:
  contents: read
  packages: write

env:
  # Adjust names/region as you like
  AZURE_LOCATION: eastus
  AZURE_GROUP_NAME: fraud-single-rg
  AZURE_ENV_NAME: fraud-single-env
  AZURE_CONTAINER_APP_NAME: fraud-single-app
  REGISTRY_SERVER: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR (GITHUB_TOKEN)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Lowercase owner/repo
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Build & Push image to GHCR
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile          # Dockerfile should run nginx + uvicorn + streamlit via start.sh
          push: true
          tags: |
            ghcr.io/${{ env.REPO }}:${{ github.sha }}
            ghcr.io/${{ env.REPO }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Azure Login (with subscription)
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate subscription context
        shell: bash
        run: |
          set -e
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
          echo "Current subscription:"
          az account show --query "{name:name, id:id, state:state}" -o tsv
          STATE=$(az account show --query "state" -o tsv)
          if [ "$STATE" != "Enabled" ]; then
            echo "::error::Subscription state is '$STATE' (must be Enabled)."
            exit 1
          fi

      - name: Lowercase owner/repo
        run: echo "REPO=${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Create/Update Azure Container App
        uses: azure/CLI@v1
        with:
          inlineScript: |
            set -e
            IMAGE="ghcr.io/${{ env.REPO }}:${{ github.sha }}"
            REGISTRY_USER="${{ github.actor }}"
            REGISTRY_PASS="${{ secrets.PAT }}"   # PAT must have read:packages (SSO-enabled if org uses SSO)

            az config set extension.use_dynamic_install=yes_without_prompt

            echo "Ensuring Resource Group and Container App Environment exist (idempotent)..."
            az group create -n "${{ env.AZURE_GROUP_NAME }}" -l "${{ env.AZURE_LOCATION }}" || true
            az containerapp env create \
              -n "${{ env.AZURE_ENV_NAME }}" \
              -g "${{ env.AZURE_GROUP_NAME }}" \
              --location "${{ env.AZURE_LOCATION }}" || true

            echo "Create or update Container Appâ€¦"
            if ! az containerapp show -n "${{ env.AZURE_CONTAINER_APP_NAME }}" -g "${{ env.AZURE_GROUP_NAME }}" &>/dev/null; then
              az containerapp create \
                -n "${{ env.AZURE_CONTAINER_APP_NAME }}" \
                -g "${{ env.AZURE_GROUP_NAME }}" \
                --environment "${{ env.AZURE_ENV_NAME }}" \
                --image "$IMAGE" \
                --ingress external \
                --target-port 80 \
                --cpu 2 --memory 4Gi \
                --registry-server "${{ env.REGISTRY_SERVER }}" \
                --registry-username "$REGISTRY_USER" \
                --registry-password "$REGISTRY_PASS" \
                --env-vars API_URL=/api/predict-raw
            else
              az containerapp registry set \
                -n "${{ env.AZURE_CONTAINER_APP_NAME }}" \
                -g "${{ env.AZURE_GROUP_NAME }}" \
                --server "${{ env.REGISTRY_SERVER }}" \
                --username "$REGISTRY_USER" \
                --password "$REGISTRY_PASS"

              az containerapp update \
                -n "${{ env.AZURE_CONTAINER_APP_NAME }}" \
                -g "${{ env.AZURE_GROUP_NAME }}" \
                --image "$IMAGE" \
                --cpu 2 --memory 4Gi \
                --set-env-vars API_URL=/api/predict-raw
            fi

            echo "Public FQDN:"
            az containerapp show \
              -n "${{ env.AZURE_CONTAINER_APP_NAME }}" \
              -g "${{ env.AZURE_GROUP_NAME }}" \
              --query properties.configuration.ingress.fqdn -o tsv
